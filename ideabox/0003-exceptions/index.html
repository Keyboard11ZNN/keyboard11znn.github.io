

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>A calling convention concept for functions with C++-like exception model &mdash; KEYBOARD11 z n. n.</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
 
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Things that can be done with an NES mapper" href="../0004-mapper/" />
    <link rel="prev" title="The inadequacy of linear terminal for age of concurrency" href="../0002-paraconsole/" />
 <link rel="apple-touch-icon" sizes="180x180" href="../../_static/apple-touch-icon.png"/>
 <link rel="mask-icon" color="#225599" href="../../_static/safari-pinned-tab.svg" />
 <meta name="theme-color" content="#225599" />
 <meta name="msapplication-TileColor" content="#225599"/>
 <meta name="msapplication-TileImage" content="../../_static/mstile-144x144.png"/>
 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #1940b9" >
          

          
            <a href="../../">
          

          
            
            <img src="../../_static/keyboard11banner.svg" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../welcome/">The Keyboard11 website begins…</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../disclaimer/">A disclaimer of sorts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../garden/">Garden of Code Monstrosities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whinecellar/">Whine Cellar</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Keyboard11 Ideabox</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../0000-qadillac/">Quick and dirty indented language lossless alpha-conversion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../0001-futomake/">How to accelerate C++ compilation without killing preprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../0002-paraconsole/">The inadequacy of linear terminal for age of concurrency</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">A calling convention concept for functions with C++-like exception model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../0004-mapper/">Things that can be done with an NES mapper</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../">Keyboard11 z n. n. website</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../">Docs</a> &raquo;</li>
        
          <li><a href="../">Keyboard11 Ideabox</a> &raquo;</li>
        
      <li>A calling convention concept for functions with C++-like exception model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="../0004-mapper/" class="btn btn-neutral float-right" title="Things that can be done with an NES mapper" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../0002-paraconsole/" class="btn btn-neutral float-left" title="The inadequacy of linear terminal for age of concurrency" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="a-calling-convention-concept-for-functions-with-c-like-exception-model">
<h1>A calling convention concept for functions with C++-like exception model<a class="headerlink" href="#a-calling-convention-concept-for-functions-with-c-like-exception-model" title="Permalink to this headline">¶</a></h1>
<div class="section" id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">¶</a></h2>
<p>With C++’s biggest advantage compared to competing programming languages
being its high performance, the two features that lower that performance
are understandably controversial, namely RTTI and exceptions. The exceptions
are the less nuanced part of this setup, mostly because they rely upon RTTI,
but for other reasons as well.</p>
<p>The most controversial, as of late, part of the exception conundrum involves
calling conventions. The most direct approach is to embed the return value
in the processor state at every return of a function, and this is the approach
proposed by Herb Sutter. However, Bjarne Stroustrup recently claimed that
this approach was tested in the past and lead to unsatisfactory results
when it came to performance of code which did not stumble upon an exception.</p>
</div>
<div class="section" id="current-practice">
<h2>Current practice<a class="headerlink" href="#current-practice" title="Permalink to this headline">¶</a></h2>
<p>The most heavy-handed convention involves heavy use of C-style stack state
saving functions.</p>
<p>There are two more advanced techniques available for use. On Windows, Microsoft
came up with something called Structural Exception Handling, and on Linux
and friends, something called DWARF-2 Unwinding Tables is present. These
should, theoretically, allow the non-throwing performance of code to reach
the equivalent of little-to-no error checking. However, this doesn’t seem to
work very well.</p>
<p>The explanation documents for DWARF-2 Unwinding Tables include a very
peculiar example, where an exception is thrown through a function that
doesn’t do anything with it. Given that RAII is a thing now, it looks
like it was not taken into account during DWARF-2 and SEH dessign, resulting
in, effectively, rethrows when a destructor is encountered.</p>
</div>
<div class="section" id="enter-stan-s-dumb-idea">
<h2>Enter Stan’s Dumb Idea<a class="headerlink" href="#enter-stan-s-dumb-idea" title="Permalink to this headline">¶</a></h2>
<p>Let’s have the exception marker without the exception marker. Let’s embed it
in the execution state.</p>
<p>This is superficially similar to Unwinding Tables, to the best of my
understanding, but is way dumber in the setup.</p>
<ol class="arabic simple">
<li><p>Find a sequence of bytes which will never appear in compiled code.
Something involving defined illegal opcodes is ideal.</p></li>
<li><p>Compile the code mostly as if a marker convention was in place.
Separate the blocks used exclusively in exception-thrown path
to avoid them polluting cache while no exception is thrown.</p></li>
<li><p>After our function, or multiple functions, embed our special not-code
sequence, and follow it with a differential pointer to the special jump
table.</p></li>
<li><p>The special jump table should contain differential pointers to return
addresses coupled with differential pointers to corresponding exception
path blocks.</p></li>
</ol>
<p>(This works with regular pointers instead of differential pointers too.
I’m suggesting the use of differential pointers because they could be placed
in position-independent code, which is advantageous in Linux shared libraries,
for instance. If you have trouble with understanding the
core concept, feel free to sub in regular pointers.)</p>
<p>When an exception is thrown, instead of returning directly from function,
we scan the executable code itself and switch the return pointer so that
it goes to the exception path (while the marker convention would contain
a conditional jump at the return point).</p>
<p>This scheme has one obvious disadvantage compared to other setups I can think
of, in that the code page must be readable by the code unless processor has
special support for the type of operation presented here. In fact, I came
up with the whole concept while considering such processor support first,
but that would obviously be useless for milliards of machines deployed today,
while doing in the wizard as shown here wouldn’t. However, setting code to
unreadable executable is, from what I hear, a pretty rare setup - I’ve heard
of hackers stumbling upon it on Wii U and being very surprised.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../0004-mapper/" class="btn btn-neutral float-right" title="Things that can be done with an NES mapper" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../0002-paraconsole/" class="btn btn-neutral float-left" title="The inadequacy of linear terminal for age of concurrency" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020-2021+, stan423321

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script>

  
  
    
   

</body>
</html>