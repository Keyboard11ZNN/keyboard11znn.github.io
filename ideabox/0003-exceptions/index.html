
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>A calling convention concept for functions with C++-like exception model &#8212; KEYBOARD11 z n. n.</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="prev" title="The inadequacy of linear terminal for age of concurrency" href="../0002-paraconsole/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../0002-paraconsole/" title="The inadequacy of linear terminal for age of concurrency"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">KEYBOARD11 z n. n.</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" accesskey="U">Keyboard11 Ideabox</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="a-calling-convention-concept-for-functions-with-c-like-exception-model">
<h1>A calling convention concept for functions with C++-like exception model<a class="headerlink" href="#a-calling-convention-concept-for-functions-with-c-like-exception-model" title="Permalink to this headline">¶</a></h1>
<div class="section" id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">¶</a></h2>
<p>With C++’s biggest advantage compared to competing programming languages
being its high performance, the two features that lower that performance
are understandably controversial, namely RTTI and exceptions. The exceptions
are the less nuanced part of this setup, mostly because they rely upon RTTI,
but for other reasons as well.</p>
<p>The most controversial, as of late, part of the exception conundrum involves
calling conventions. The most direct approach is to embed the return value
in the processor state at every return of a function, and this is the approach
proposed by Herb Sutter. However, Bjarne Stroustrup recently claimed that
this approach was tested in the past and lead to unsatisfactory results
when it came to performance of code which did not stumble upon an exception.</p>
</div>
<div class="section" id="current-practice">
<h2>Current practice<a class="headerlink" href="#current-practice" title="Permalink to this headline">¶</a></h2>
<p>The most heavy-handed convention involves heavy use of C-style stack state
saving functions.</p>
<p>There are two more advanced techniques available for use. On Windows, Microsoft
came up with something called Structural Exception Handling, and on Linux
and friends, something called DWARF-2 Unwinding Tables is present. These
should, theoretically, allow the non-throwing performance of code to reach
the equivalent of little-to-no error checking. However, this doesn’t seem to
work very well.</p>
<p>The explanation documents for DWARF-2 Unwinding Tables include a very
peculiar example, where an exception is thrown through a function that
doesn’t do anything with it. Given that RAII is a thing now, it looks
like it was not taken into account during DWARF-2 and SEH dessign, resulting
in, effectively, rethrows when a destructor is encountered.</p>
</div>
<div class="section" id="enter-stan-s-dumb-idea">
<h2>Enter Stan’s Dumb Idea<a class="headerlink" href="#enter-stan-s-dumb-idea" title="Permalink to this headline">¶</a></h2>
<p>Let’s have the exception marker without the exception marker. Let’s embed it
in the execution state.</p>
<p>This is superficially similar to Unwinding Tables, to the best of my
understanding, but is way dumber in the setup.</p>
<ol class="arabic simple">
<li><p>Find a sequence of bytes which will never appear in compiled code.
Something involving defined illegal opcodes is ideal.</p></li>
<li><p>Compile the code mostly as if a marker convention was in place.
Separate the blocks used exclusively in exception-thrown path
to avoid them polluting cache while no exception is thrown.</p></li>
<li><p>After our function, or multiple functions, embed our special not-code
sequence, and follow it with a differential pointer to the special jump
table.</p></li>
<li><p>The special jump table should contain differential pointers to return
addresses coupled with differential pointers to corresponding exception
path blocks.</p></li>
</ol>
<p>(This works with regular pointers instead of differential pointers too.
I’m suggesting the use of differential pointers because they could be placed
in position-independent code, which is advantageous in Linux shared libraries,
for instance. If you have trouble with understanding the
core concept, feel free to sub in regular pointers.)</p>
<p>When an exception is thrown, instead of returning directly from function,
we scan the executable code itself and switch the return pointer so that
it goes to the exception path (while the marker convention would contain
a conditional jump at the return point).</p>
<p>This scheme has one obvious disadvantage compared to other setups I can think
of, in that the code page must be readable by the code unless processor has
special support for the type of operation presented here. In fact, I came
up with the whole concept while considering such processor support first,
but that would obviously be useless for milliards of machines deployed today,
while doing in the wizard as shown here wouldn’t. However, setting code to
unreadable executable is, from what I hear, a pretty rare setup - I’ve heard
of hackers stumbling upon it on Wii U and being very surprised.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/keyboard11banner.svg" alt="Logo"/>
            </a></p>
  <h3><a href="../../">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">A calling convention concept for functions with C++-like exception model</a><ul>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#current-practice">Current practice</a></li>
<li><a class="reference internal" href="#enter-stan-s-dumb-idea">Enter Stan’s Dumb Idea</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../0002-paraconsole/"
                        title="previous chapter">The inadequacy of linear terminal for age of concurrency</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../0002-paraconsole/" title="The inadequacy of linear terminal for age of concurrency"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">KEYBOARD11 z n. n.</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" >Keyboard11 Ideabox</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020+, stan423321.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.3.1.
    </div>
  </body>
</html>